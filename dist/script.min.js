$(document).ready(function(){var h=15;var q=["no_right_turn","no_left_turn","no_u_turn","no_straight_on","only_right_turn","only_left_turn","only_straight_on","no_entry","no_exit"];var A={normal:"white",only:"#0f0",no:"red"};var u=new Spinner({color:"#fff",lines:12,width:3,radius:7});function K(){u.spin(document.getElementById("spinner"))}function G(){u.stop()}var n=C();var o=new L.Map("map",n);o.on("moveend",function(){E()});E();L.control.locate({drawCircle:false,keepCurrentZoomLevel:true}).addTo(o);var j="http://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png";var m='Map data Â© <a href="http://openstreetmap.org">OpenStreetMap</a> contributors';var l=new L.TileLayer(j,{minZoom:1,maxZoom:19,attribution:m});o.addLayer(l);var F=L.tileLayer("data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAQAAAAEAAQAAAAB0CZXLAAAAH0lEQVR4Ae3BAQEAAAgCoP6v7kYpMAAAAAAAAAAAzy0hAAABhF/yqwAAAABJRU5ErkJggg==",{opacity:0.5,minZoom:1,maxZoom:19});o.addLayer(F);var g=[];for(var D=0;D<5;D++){g.push(L.layerGroup().addTo(o))}var J=L.markerClusterGroup({maxClusterRadius:20}).addTo(o);g.push(J);function C(){var M=window.location.href;var O=M.lastIndexOf("#");if(O!=-1){M=M.substring(O+1);var N=M.split("/");if(N.length==3){return{center:[N[1],N[2]],zoom:N[0]}}}var i=Cookies.getJSON("location");if(i!=undefined){return i}return{center:[52.45,13.35],zoom:14}}function E(){var i=o.getCenter();var M=5;var N="#"+o.getZoom()+"/"+i.lat.toFixed(M)+"/"+i.lng.toFixed(M);window.history.replaceState({},"",N);if(o.getZoom()<h){$(".zoom-hint").show()}else{$(".zoom-hint").hide()}b();Cookies.set("location",{center:o.getCenter(),zoom:o.getZoom()},{expires:365})}var r,k;var t;function b(){if(o.getZoom()<h){return}var P=o.getBounds();var N=P.pad(0.2);if(r!=undefined){if(r.contains(P)){p();return}}if(k!=undefined&&k){if(k.contains(P)){return}else{p()}}K();k=N;var O=N.getSouthEast().lat+","+N.getNorthWest().lng+","+N.getNorthWest().lat+","+N.getSouthEast().lng;var M='[out:json][timeout:25];(relation["type"="restriction"]('+O+');node(r);way(bn)["highway"]["highway"~"^motorway|^trunk|^primary|^secondary|^tertiary|living_street|unclassified|residential|service|road"];);out body;>;out body;';console.log(M);var i="http://overpass.osm.rambler.ru/cgi/interpreter?data="+encodeURIComponent(M);t=$.ajax({url:i,type:"GET",crossDomain:true,success:z})}function p(){G();if(t!=undefined&&t){t.abort();t=null}k=null}var x,I,f;function z(i){console.log("Success");G();t=null;r=k;k=null;x=[];I=[];f=[];$.each(i.elements,function(N,O){var P=O.id;switch(O.type){case"node":x[P]=O;break;case"way":I[P]=O;break;case"relation":f[P]=O;break}});$.each(g,function(N,O){O.clearLayers()});var M=[];$.each(s(f,false),function(V,aa){var Y=[];var P=[];var S=0;var X=0;var Z=0;for(var R=0;R<aa.members.length;R++){var Q=aa.members[R];if(Q.role=="via"){if(Q.type=="node"){Y.push(x[Q.ref])}else{return}}else{if(Q.type=="way"&&Q.role=="from"){S++;P.push({type:"from",way_ref:Q.ref})}else{if(Q.type=="way"&&Q.role=="to"){X++;P.push({type:"to",way_ref:Q.ref})}else{if(Q.type=="node"&&Q.role=="location_hint"){}else{Z++}}}}}if(Y.length==0){return}if(Y.length>1){$.each(Y,function(ac,ad){d([ad.lat,ad.lon],aa,'There are multiple "via"-nodes',false)});return}Y=Y[0];if(aa.tags.restriction==undefined){var ab=s(aa.tags,true);for(var R=0;R<ab.length;R++){if(ab[R].startsWith("restriction:")){return}}d([Y.lat,Y.lon],aa,'There is no "restriction"-tag',false);return}var T=aa.tags.restriction;var O=T.split("_")[0];if($.inArray(T,q)==-1){var U=false;if(O=="no"||O=="only"){U=true}d([Y.lat,Y.lon],aa,'Unknown restriction "'+a(T)+'"',U);if(!U){return}}if(S==0){d([Y.lat,Y.lon],aa,'No "from"-members',false);return}if(X==0){d([Y.lat,Y.lon],aa,'No "to"-members',false);return}if(S>1&&T!="no_entry"){d([Y.lat,Y.lon],aa,'More than 1 "from"-members, but restriction is not "no_entry"',true)}if(X>1&&T!="no_entry"){d([Y.lat,Y.lon],aa,'More than 1 "to"-members, but restriction is not "no_exit"',true)}if(Z>0){d([Y.lat,Y.lon],aa,"There are "+Z+" unnecessary relation members",true)}for(var R=0;R<P.length;R++){var W=I[P[R].way_ref];if(Y.id!=W.nodes[0]&&Y.id!=W.nodes[W.nodes.length-1]){d([Y.lat,Y.lon],aa,"There are from/to-members that aren't connected to the via node",false);return}}var N={id:aa.id,type:T,access:O,members:P,nTo:X,nFrom:S};if(M[Y.id]==undefined){M[Y.id]={via:Y,restrictions:[N],ways:[]}}else{M[Y.id].restrictions.push(N)}});$.each(s(I),function(O,N){if(N.tags!=undefined&&N.tags.highway!=undefined){$.each(N.nodes,function(Q,R){if(M[R]!=undefined){var P=H(N,Q);M[R].ways=M[R].ways.concat(P)}})}});$.each(s(M,true),function(O,P){var N=M[P];$.each(N.restrictions,function(R,Q){$.each(Q.members,function(U,V){for(var S=0;S<N.ways.length;S++){var T=N.ways[S];if(V.way_ref==T.id){M[P].restrictions[R].members[U].oneway=T.oneway;break}}})})});$.each(s(M),function(O,N){c(N)});$.each(s(M),function(O,N){y(N)});e()}function e(){$.each(g,function(i,M){o.removeLayer(M);o.addLayer(M)})}function H(M,R){var P=0;if(M.tags.oneway!=undefined){switch(M.tags.oneway){case"yes":case"1":P=1;break;case"-1":P=-1;break}}var N=[];if(R!=0){var O=B(M,0,R+1,true);var i=P==0?0:-P;var Q={id:M.id,nodes:O,oneway:i};N.push(Q)}if(R!=M.nodes.length-1){var O=B(M,R,M.nodes.length,false);var Q={id:M.id,nodes:O,oneway:P};N.push(Q)}return N}function B(ab,O,S,W){var U=ab.nodes.slice(O,S);var Q=[];$.each(U,function(i,ad){var ac=x[ad];Q.push({lat:ac.lat,lon:ac.lon})});if(W){Q.reverse()}var X=[];var R=45;var V=0;for(var T=0;T<Q.length;T++){var P=Q[T];if(T==0){X.push(P)}else{var N=Q[T-1];var aa=L.latLng(N).distanceTo(P);if(V+aa<R){X.push(P);V+=aa}else{var Z=(R-V)/aa;var Y=N.lat+((P.lat-N.lat)*Z);var M=N.lon+((P.lon-N.lon)*Z);X.push([Y,M]);break}}}return X}function c(i){$.each(i.ways,function(R,T){var O=false;var P=false;var N=[];$.each(w(T.id,i.restrictions),function(W,X){var V=X.restriction.access;if(V=="no"){O=true}else{if(V=="only"){P=true}}N.push({access:V,role:X.member.type})});var U={opacity:1,clickable:false};if(N.length==0){U.color=A.normal;U.weight=2}else{U.weight=3;if(P){U.color=A.only}else{U.color=A.no}}var M=N.length==0?2:3;var S=L.polyline(T.nodes,U);g[M].addLayer(S);if(T.oneway!=0){var Q=T.oneway==1?"forward":"backward";v(S,A.normal,"both",Q,0,1.5)}$.each(N,function(X,Z){var V=Z.access=="only"?A.only:A.no;var Y=Z.role=="to"?"forward":"backward";var W=T.oneway==0?"right":"both";v(S,V,W,Y,1,2.5)});if(P&&O){U.color=A.no;U.dashArray=[5,5];U.lineCap="butt";var S=L.polyline(T.nodes,U);g[3].addLayer(S)}});g[4].addLayer(L.circleMarker(i.via,{fillColor:"black",weight:0,fillOpacity:0.8,clickable:false}).setRadius(3))}function w(M,i){var N=[];$.each(i,function(P,O){$.each(O.members,function(Q,R){if(R.way_ref==M){N.push({restriction:O,member:R})}})});return N}function v(N,M,P,S,O,R){var Q=Math.pow(2,o.getZoom()-14);var i=L.polylineDecorator(N,{patterns:[{offset:Q,endOffset:0,repeat:Q/4*3,symbol:L.Symbol.arrowHead({pixelSize:Q/2,side:P,direction:S,pathOptions:{weight:R,fillOpacity:0,opacity:1,color:M}})}]});g[O].addLayer(i)}function y(M){var P=true;$.each(M.restrictions,function(Q,i){$.each(i.members,function(R,U){var S=U.type;var T=U.way_ref;if((S=="to"&&U.oneway==-1)||(S=="from"&&U.oneway==1)){d(M.via,f[i.id],'The "'+S+'"-member is a one-way street that goes in the wrong direction',false);P=false}})});if(!P){return}var O=[];$.each(M.ways,function(R,Q){if(Q.oneway!=-1){O.push({way_ref:Q.id,access:false,index:R})}});$.each(M.restrictions,function(T,Q){var R=O.length-1;for(var S=0;S<Q.members.length;S++){var U=Q.members[S];if(U.type=="from"&&U.oneway==-1){R++;break}}if(Q.access=="only"&&R==Q.nTo){d(M.via,f[Q.id],"Unnecessary restriction: There is no other turn possibility",true)}});$.each(M.ways,function(S,R){if(R.oneway!=1){var Q=false;var U=w(R.id,M.restrictions);for(var T=0;T<U.length;T++){if(U[T].member.type=="from"){Q=true;break}}if(!Q){$.each(O,function(V,W){if(W.index!=S){O[V].access=true}})}}});$.each(M.restrictions,function(Q,i){var R=[];$.each(i.members,function(S,T){if(T.type=="to"){R[T.way_ref]=true}});$.each(O,function(S,T){if((R[T.way_ref]!=undefined&&i.access=="only")||(R[T.way_ref]==undefined&&i.access=="no")){O[S].access=true}})});for(var N=0;N<O.length;N++){if(!O[N].access){d(M.via,M.via,'The restrictions at this node make a street inaccessible. Consider using "oneway" or "access=no" instead of restrictions.',false);return}}}function d(P,Q,R,O){var M="";var N="";switch(Q.type){case"node":N="Node";M="http://www.openstreetmap.org/node/"+Q.id;break;case"relation":N="Relation";M="http://www.openstreetmap.org/relation/"+Q.id;break}R="<b>"+(O?"Warning":"Error")+"</b>: "+R;R+="<br>"+N+' <a href="'+M+'" target="_blank">'+Q.id+"</a>";console.log(R);var S=O?"orange":"red";var i=L.circleMarker(P,{fillOpacity:1,opacity:1,fillColor:S,color:"white"}).setRadius(7).bindPopup(R,{autoPan:false,offset:[0,-5]});J.addLayer(i)}function s(i,M){var O=[];for(var N in i){if(i.hasOwnProperty(N)){if(M){O.push(N)}else{O.push(i[N])}}}return O}function a(i){return i.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;")}});