$(document).ready(function(){var h=15;var r=["no_right_turn","no_left_turn","no_u_turn","no_straight_on","only_right_turn","only_left_turn","only_straight_on","no_entry","no_exit"];var k=["^motorway","^trunk","^primary","^secondary","^tertiary","living_street","unclassified","residential","service","road"];var B={normal:"white",only:"#0f0",no:"red"};var v=new Spinner({color:"#fff",lines:12,width:3,radius:7});function M(){v.spin(document.getElementById("spinner"))}function H(){v.stop()}var o=D();var p=new L.Map("map",o);p.on("moveend",function(){F()});F();L.control.locate({drawCircle:false,keepCurrentZoomLevel:true}).addTo(p);var j="http://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png";var n='Map data Â© <a href="http://openstreetmap.org">OpenStreetMap</a> contributors';var m=new L.TileLayer(j,{minZoom:1,maxZoom:19,attribution:n});p.addLayer(m);var G=L.tileLayer("data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAQAAAAEAAQAAAAB0CZXLAAAAH0lEQVR4Ae3BAQEAAAgCoP6v7kYpMAAAAAAAAAAAzy0hAAABhF/yqwAAAABJRU5ErkJggg==",{opacity:0.5,minZoom:1,maxZoom:19});p.addLayer(G);var g=[];for(var E=0;E<5;E++){g.push(L.layerGroup().addTo(p))}var K=L.markerClusterGroup({maxClusterRadius:20}).addTo(p);g.push(K);function D(){var N=window.location.href;var P=N.lastIndexOf("#");if(P!=-1){N=N.substring(P+1);var O=N.split("/");if(O.length==3){return{center:[O[1],O[2]],zoom:O[0]}}}var i=Cookies.getJSON("location");if(i!=undefined){return i}return{center:[52.45,13.35],zoom:14}}function F(){var i=p.getCenter();var N=5;var O="#"+p.getZoom()+"/"+i.lat.toFixed(N)+"/"+i.lng.toFixed(N);window.history.replaceState({},"",O);if(p.getZoom()<h){$(".zoom-hint").show()}else{$(".zoom-hint").hide()}b();Cookies.set("location",{center:p.getCenter(),zoom:p.getZoom()},{expires:365})}var s,l;var u;function b(){if(p.getZoom()<h){return}var Q=p.getBounds();var O=Q.pad(0.2);if(s!=undefined){if(s.contains(Q)){q();return}}if(l!=undefined&&l){if(l.contains(Q)){return}else{q()}}M();l=O;var P=O.getSouthEast().lat+","+O.getNorthWest().lng+","+O.getNorthWest().lat+","+O.getSouthEast().lng;var N='[out:json][timeout:25];(relation["type"="restriction"]('+P+');node(r);way(bn)["highway"]["highway"~"'+k.join("|")+'"];);out body;>;out body;';console.log(N);var i="http://overpass.osm.rambler.ru/cgi/interpreter?data="+encodeURIComponent(N);u=$.ajax({url:i,type:"GET",crossDomain:true,success:A})}function q(){H();if(u!=undefined&&u){u.abort();u=null}l=null}var y,J,f;function A(i){console.log("Success");H();u=null;s=l;l=null;y=[];J=[];f=[];$.each(i.elements,function(O,P){var Q=P.id;switch(P.type){case"node":y[Q]=P;break;case"way":J[Q]=P;break;case"relation":f[Q]=P;break}});$.each(g,function(O,P){P.clearLayers()});var N=[];$.each(t(f,false),function(P,S){var af=[];var ad=[];var ac=0;var O=0;var ae=0;for(var ab=0;ab<S.members.length;ab++){var R=S.members[ab];if(R.role=="via"){if(R.type=="node"){af.push(y[R.ref])}else{return}}else{if(R.type=="way"&&R.role=="from"){ac++;ad.push({type:"from",way_ref:R.ref})}else{if(R.type=="way"&&R.role=="to"){O++;ad.push({type:"to",way_ref:R.ref})}else{if(R.type=="node"&&R.role=="location_hint"){}else{ae++}}}}}if(af.length==0){return}if(af.length>1){$.each(af,function(ah,ai){d([ai.lat,ai.lon],S,'There are multiple "via"-nodes',false)});return}af=af[0];for(var ab=0;ab<ad.length;ab++){var W=J[ad[ab].way_ref];if(W.tags.highway==undefined){d([af.lat,af.lon],S,'There is a member way that has no "highway" tag',false);return}var ag=W.tags.highway;var Q=false;for(var aa=0;aa<k.length;aa++){var Y=k[aa];if(ag.match(Y)){Q=true;break}}if(!Q){return}}if(S.tags.restriction==undefined){var X=t(S.tags,true);for(var ab=0;ab<X.length;ab++){if(X[ab].startsWith("restriction:")){return}}d([af.lat,af.lon],S,'There is no "restriction"-tag',false);return}var T=S.tags.restriction;var U=T.split("_")[0];if($.inArray(T,r)==-1){var Z=false;if(U=="no"||U=="only"){Z=true}d([af.lat,af.lon],S,'Unknown restriction "'+a(T)+'"',Z);if(!Z){return}}if(ac==0){d([af.lat,af.lon],S,'No "from"-members',false);return}if(O==0){d([af.lat,af.lon],S,'No "to"-members',false);return}if(ac>1&&T!="no_entry"){d([af.lat,af.lon],S,'More than 1 "from"-members, but restriction is not "no_entry"',true)}if(O>1&&T!="no_entry"){d([af.lat,af.lon],S,'More than 1 "to"-members, but restriction is not "no_exit"',true)}if(ae>0){d([af.lat,af.lon],S,"There are "+ae+" unnecessary relation members",true)}for(var ab=0;ab<ad.length;ab++){var W=J[ad[ab].way_ref];if(af.id!=W.nodes[0]&&af.id!=W.nodes[W.nodes.length-1]){d([af.lat,af.lon],S,"There are from/to-members that aren't connected to the via node",false);return}}var V={id:S.id,type:T,access:U,members:ad,nTo:O,nFrom:ac};if(N[af.id]==undefined){N[af.id]={via:af,restrictions:[V],ways:[]}}else{N[af.id].restrictions.push(V)}});$.each(t(J),function(P,O){if(O.tags!=undefined&&O.tags.highway!=undefined){$.each(O.nodes,function(R,S){if(N[S]!=undefined){var Q=I(O,R);N[S].ways=N[S].ways.concat(Q)}})}});$.each(t(N,true),function(P,Q){var O=N[Q];$.each(O.restrictions,function(S,R){$.each(R.members,function(V,W){for(var T=0;T<O.ways.length;T++){var U=O.ways[T];if(W.way_ref==U.id){N[Q].restrictions[S].members[V].oneway=U.oneway;break}}})})});$.each(t(N),function(P,O){c(O)});$.each(t(N),function(P,O){z(O)});e()}function e(){$.each(g,function(i,N){p.removeLayer(N);p.addLayer(N)})}function I(N,S){var Q=0;if(N.tags.oneway!=undefined){switch(N.tags.oneway){case"yes":case"1":Q=1;break;case"-1":Q=-1;break}}var O=[];if(S!=0){var P=C(N,0,S+1,true);var i=Q==0?0:-Q;var R={id:N.id,nodes:P,oneway:i};O.push(R)}if(S!=N.nodes.length-1){var P=C(N,S,N.nodes.length,false);var R={id:N.id,nodes:P,oneway:Q};O.push(R)}return O}function C(ac,P,T,X){var V=ac.nodes.slice(P,T);var R=[];$.each(V,function(i,ae){var ad=y[ae];R.push({lat:ad.lat,lon:ad.lon})});if(X){R.reverse()}var Y=[];var S=45;var W=0;for(var U=0;U<R.length;U++){var Q=R[U];if(U==0){Y.push(Q)}else{var O=R[U-1];var ab=L.latLng(O).distanceTo(Q);if(W+ab<S){Y.push(Q);W+=ab}else{var aa=(S-W)/ab;var Z=O.lat+((Q.lat-O.lat)*aa);var N=O.lon+((Q.lon-O.lon)*aa);Y.push([Z,N]);break}}}return Y}function c(i){$.each(i.ways,function(S,U){var P=false;var Q=false;var O=[];$.each(x(U.id,i.restrictions),function(X,Y){var W=Y.restriction.access;if(W=="no"){P=true}else{if(W=="only"){Q=true}}O.push({access:W,role:Y.member.type})});var V={opacity:1,clickable:false};if(O.length==0){V.color=B.normal;V.weight=2}else{V.weight=3;if(Q){V.color=B.only}else{V.color=B.no}}var N=O.length==0?2:3;var T=L.polyline(U.nodes,V);g[N].addLayer(T);if(U.oneway!=0){var R=U.oneway==1?"forward":"backward";w(T,B.normal,"both",R,0,1.5)}$.each(O,function(Y,aa){var W=aa.access=="only"?B.only:B.no;var Z=aa.role=="to"?"forward":"backward";var X=U.oneway==0?"right":"both";w(T,W,X,Z,1,2.5)});if(Q&&P){V.color=B.no;V.dashArray=[5,5];V.lineCap="butt";var T=L.polyline(U.nodes,V);g[3].addLayer(T)}});g[4].addLayer(L.circleMarker(i.via,{fillColor:"black",weight:0,fillOpacity:0.8,clickable:false}).setRadius(3))}function x(N,i){var O=[];$.each(i,function(Q,P){$.each(P.members,function(R,S){if(S.way_ref==N){O.push({restriction:P,member:S})}})});return O}function w(O,N,Q,T,P,S){var R=Math.pow(2,p.getZoom()-14);var i=L.polylineDecorator(O,{patterns:[{offset:R,endOffset:0,repeat:R/4*3,symbol:L.Symbol.arrowHead({pixelSize:R/2,side:Q,direction:T,pathOptions:{weight:S,fillOpacity:0,opacity:1,color:N}})}]});g[P].addLayer(i)}function z(P){var S=true;$.each(P.restrictions,function(U,i){$.each(i.members,function(V,Y){var W=Y.type;var X=Y.way_ref;if((W=="to"&&Y.oneway==-1)||(W=="from"&&Y.oneway==1)){d(P.via,f[i.id],'The "'+W+'"-member is a one-way street that goes in the wrong direction',false);S=false}})});if(!S){return}var R=[];$.each(P.ways,function(V,U){if(U.oneway!=-1){R.push({way_ref:U.id,access:false,index:V})}});$.each(P.restrictions,function(X,U){var V=R.length-1;for(var W=0;W<U.members.length;W++){var Y=U.members[W];if(Y.type=="from"&&Y.oneway==-1){V++;break}}if(U.access=="only"&&V==U.nTo){d(P.via,f[U.id],"Unnecessary restriction: There is no other turn possibility",true,"#66DE62")}});$.each(P.ways,function(W,V){if(V.oneway!=1){var U=false;var Y=x(V.id,P.restrictions);for(var X=0;X<Y.length;X++){if(Y[X].member.type=="from"){U=true;break}}if(!U){$.each(R,function(Z,aa){if(aa.index!=W){R[Z].access=true}})}}});$.each(P.restrictions,function(U,i){var V=[];$.each(i.members,function(W,X){if(X.type=="to"){V[X.way_ref]=true}});$.each(R,function(W,X){if((V[X.way_ref]!=undefined&&i.access=="only")||(V[X.way_ref]==undefined&&i.access=="no")){R[W].access=true}})});for(var Q=0;Q<R.length;Q++){if(!R[Q].access){var O=J[R[Q].way_ref];var T;if(O.tags.name!=undefined){var N=a(O.tags.name);T='The restrictions at this node make the street "'+N+'" inaccessible (can\'t be entered from any street that is connected to the via-node). This might indicate that using "oneway" or "access=no" may be more appropriate than using restrictions.'}else{T='The restrictions at this node make a street inaccessible (can\'t be entered from any street that is connected to the via-node). This might indicate that using "oneway" or "access=no" may be more appropriate than using restrictions.'}d(P.via,P.via,T,true)}}}function d(S,P,O,U,Q){var i="";var T="";switch(P.type){case"node":T="Node";i="http://www.openstreetmap.org/node/"+P.id;break;case"relation":T="Relation";i="http://www.openstreetmap.org/relation/"+P.id;break}O="<b>"+(U?"Warning":"Error")+"</b>: "+O;O+="<br>"+T+' <a href="'+i+'" target="_blank">'+P.id+"</a>";console.log(O);var N;if(typeof Q==="undefined"){N=U?"orange":"red"}else{N=Q}var R=L.circleMarker(S,{fillOpacity:1,opacity:1,fillColor:N,color:"white"}).setRadius(7).bindPopup(O,{autoPan:false,offset:[0,-5]});K.addLayer(R)}function t(i,N){var P=[];for(var O in i){if(i.hasOwnProperty(O)){if(N){P.push(O)}else{P.push(i[O])}}}return P}function a(i){return i.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;")}});