$(document).ready(function(){var v=15;var c=["no_right_turn","no_left_turn","no_u_turn","no_straight_on","only_right_turn","only_left_turn","only_straight_on","no_entry","no_exit"];var p={normal:"white",only:"#0f0",no:"red"};var k=new Spinner({color:"#fff",lines:12,width:3,radius:7});function f(){k.spin(document.getElementById("spinner"))}function x(){k.stop()}var e=Cookies.getJSON("location");if(e==undefined){e={center:[52.45,13.35],zoom:14}}var I=new L.Map("map",e);I.on("moveend",function(){H()});H();L.control.locate({drawCircle:false,keepCurrentZoomLevel:true}).addTo(I);var l="http://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png";var b='Map data Â© <a href="http://openstreetmap.org">OpenStreetMap</a> contributors';var h=new L.TileLayer(l,{minZoom:1,maxZoom:19,attribution:b});I.addLayer(h);var C=L.tileLayer("data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAQAAAAEAAQAAAAB0CZXLAAAAH0lEQVR4Ae3BAQEAAAgCoP6v7kYpMAAAAAAAAAAAzy0hAAABhF/yqwAAAABJRU5ErkJggg==",{opacity:0.5,minZoom:1,maxZoom:19});I.addLayer(C);var D=[];for(var A=0;A<5;A++){D.push(L.layerGroup().addTo(I))}var q=L.markerClusterGroup({maxClusterRadius:20}).addTo(I);D.push(q);function H(){if(I.getZoom()<v){$(".zoom-hint").show()}else{$(".zoom-hint").hide()}o();Cookies.set("location",{center:I.getCenter(),zoom:I.getZoom()},{expires:365})}var n,B;var t;function o(){if(I.getZoom()<v){return}var O=I.getBounds();var M=O.pad(0.2);if(n!=undefined){if(n.contains(O)){z();return}}if(B!=undefined&&B){if(B.contains(O)){return}else{z()}}f();B=M;var N=M.getSouthEast().lat+","+M.getNorthWest().lng+","+M.getNorthWest().lat+","+M.getSouthEast().lng;var K='[out:json][timeout:25];(relation["type"="restriction"]('+N+');node(r);way(bn)["highway"]["highway"~"^motorway|^trunk|^primary|^secondary|^tertiary|living_street|unclassified|residential|service|road"];);out body;>;out body;';console.log(K);var i="http://overpass.osm.rambler.ru/cgi/interpreter?data="+encodeURIComponent(K);t=$.ajax({url:i,type:"GET",crossDomain:true,success:r})}function z(){x();if(t!=undefined&&t){t.abort();t=null}B=null}var w,a,j;function r(i){console.log("Success");x();t=null;n=B;B=null;w=[];a=[];j=[];$.each(i.elements,function(M,N){var O=N.id;switch(N.type){case"node":w[O]=N;break;case"way":a[O]=N;break;case"relation":j[O]=N;break}});$.each(D,function(M,N){N.clearLayers()});var K=[];$.each(u(j,false),function(U,Z){var X=[];var O=[];var R=0;var W=0;var Y=0;for(var Q=0;Q<Z.members.length;Q++){var P=Z.members[Q];if(P.role=="via"){if(P.type=="node"){X.push(w[P.ref])}else{return}}else{if(P.type=="way"&&P.role=="from"){R++;O.push({type:"from",way_ref:P.ref})}else{if(P.type=="way"&&P.role=="to"){W++;O.push({type:"to",way_ref:P.ref})}else{if(P.type=="node"&&P.role=="location_hint"){}else{Y++}}}}}if(X.length==0){return}if(X.length>1){$.each(X,function(ab,ac){d([ac.lat,ac.lon],Z,'There are multiple "via"-nodes',false)});return}X=X[0];if(Z.tags.restriction==undefined){var aa=u(Z.tags,true);for(var Q=0;Q<aa.length;Q++){if(aa[Q].startsWith("restriction:")){return}}d([X.lat,X.lon],Z,'There is no "restriction"-tag',false);return}var S=Z.tags.restriction;var N=S.split("_")[0];if($.inArray(S,c)==-1){var T=false;if(N=="no"||N=="only"){T=true}d([X.lat,X.lon],Z,'Unknown restriction "'+y(S)+'"',T);if(!T){return}}if(R==0){d([X.lat,X.lon],Z,'No "from"-members',false);return}if(W==0){d([X.lat,X.lon],Z,'No "to"-members',false);return}if(R>1&&S!="no_entry"){d([X.lat,X.lon],Z,'More than 1 "from"-members, but restriction is not "no_entry"',true)}if(W>1&&S!="no_entry"){d([X.lat,X.lon],Z,'More than 1 "to"-members, but restriction is not "no_exit"',true)}if(Y>0){d([X.lat,X.lon],Z,"There are "+Y+" unnecessary relation members",true)}for(var Q=0;Q<O.length;Q++){var V=a[O[Q].way_ref];if(X.id!=V.nodes[0]&&X.id!=V.nodes[V.nodes.length-1]){d([X.lat,X.lon],Z,"There are from/to-members that aren't connected to the via node",false);return}}var M={id:Z.id,type:S,access:N,members:O,nTo:W,nFrom:R};if(K[X.id]==undefined){K[X.id]={via:X,restrictions:[M],ways:[]}}else{K[X.id].restrictions.push(M)}});$.each(u(a),function(N,M){if(M.tags!=undefined&&M.tags.highway!=undefined){$.each(M.nodes,function(P,Q){if(K[Q]!=undefined){var O=s(M,P);K[Q].ways=K[Q].ways.concat(O)}})}});$.each(u(K,true),function(N,O){var M=K[O];$.each(M.restrictions,function(Q,P){$.each(P.members,function(T,U){for(var R=0;R<M.ways.length;R++){var S=M.ways[R];if(U.way_ref==S.id){K[O].restrictions[Q].members[T].oneway=S.oneway;break}}})})});$.each(u(K),function(N,M){E(M)});$.each(u(K),function(N,M){m(M)});F()}function F(){$.each(D,function(i,K){I.removeLayer(K);I.addLayer(K)})}function s(K,Q){var O=0;if(K.tags.oneway!=undefined){switch(K.tags.oneway){case"yes":case"1":O=1;break;case"-1":O=-1;break}}var M=[];if(Q!=0){var N=G(K,0,Q+1,true);var i=O==0?0:-O;var P={id:K.id,nodes:N,oneway:i};M.push(P)}if(Q!=K.nodes.length-1){var N=G(K,Q,K.nodes.length,false);var P={id:K.id,nodes:N,oneway:O};M.push(P)}return M}function G(aa,N,R,V){var T=aa.nodes.slice(N,R);var P=[];$.each(T,function(i,ac){var ab=w[ac];P.push({lat:ab.lat,lon:ab.lon})});if(V){P.reverse()}var W=[];var Q=45;var U=0;for(var S=0;S<P.length;S++){var O=P[S];if(S==0){W.push(O)}else{var M=P[S-1];var Z=L.latLng(M).distanceTo(O);if(U+Z<Q){W.push(O);U+=Z}else{var Y=(Q-U)/Z;var X=M.lat+((O.lat-M.lat)*Y);var K=M.lon+((O.lon-M.lon)*Y);W.push([X,K]);break}}}return W}function E(i){$.each(i.ways,function(Q,S){var N=false;var O=false;var M=[];$.each(J(S.id,i.restrictions),function(V,W){var U=W.restriction.access;if(U=="no"){N=true}else{if(U=="only"){O=true}}M.push({access:U,role:W.member.type})});var T={opacity:1,clickable:false};if(M.length==0){T.color=p.normal;T.weight=2}else{T.weight=3;if(O){T.color=p.only}else{T.color=p.no}}var K=M.length==0?2:3;var R=L.polyline(S.nodes,T);D[K].addLayer(R);if(S.oneway!=0){var P=S.oneway==1?"forward":"backward";g(R,p.normal,"both",P,0,1.5)}$.each(M,function(W,Y){var U=Y.access=="only"?p.only:p.no;var X=Y.role=="to"?"forward":"backward";var V=S.oneway==0?"right":"both";g(R,U,V,X,1,2.5)});if(O&&N){T.color=p.no;T.dashArray=[5,5];T.lineCap="butt";var R=L.polyline(S.nodes,T);D[3].addLayer(R)}});D[4].addLayer(L.circleMarker(i.via,{fillColor:"black",weight:0,fillOpacity:0.8,clickable:false}).setRadius(3))}function J(K,i){var M=[];$.each(i,function(O,N){$.each(N.members,function(P,Q){if(Q.way_ref==K){M.push({restriction:N,member:Q})}})});return M}function g(M,K,O,R,N,Q){var P=Math.pow(2,I.getZoom()-14);var i=L.polylineDecorator(M,{patterns:[{offset:P,endOffset:0,repeat:P/4*3,symbol:L.Symbol.arrowHead({pixelSize:P/2,side:O,direction:R,pathOptions:{weight:Q,fillOpacity:0,opacity:1,color:K}})}]});D[N].addLayer(i)}function m(K){var O=true;$.each(K.restrictions,function(P,i){$.each(i.members,function(Q,T){var R=T.type;var S=T.way_ref;if((R=="to"&&T.oneway==-1)||(R=="from"&&T.oneway==1)){d(K.via,j[i.id],'The "'+R+'"-member is a one-way street that goes in the wrong direction',false);O=false}})});if(!O){return}var N=[];$.each(K.ways,function(Q,P){if(P.oneway!=-1){N.push({way_ref:P.id,access:false,index:Q})}});$.each(K.restrictions,function(S,P){var Q=N.length-1;for(var R=0;R<P.members.length;R++){var T=P.members[R];if(T.type=="from"&&T.oneway==-1){Q++;break}}if(P.access=="only"&&Q==P.nTo){d(K.via,j[P.id],"Unnecessary restriction: There is no other turn possibility",true)}});$.each(K.ways,function(R,Q){if(Q.oneway!=1){var P=false;var T=J(Q.id,K.restrictions);for(var S=0;S<T.length;S++){if(T[S].member.type=="from"){P=true;break}}if(!P){$.each(N,function(U,V){if(V.index!=R){N[U].access=true}})}}});$.each(K.restrictions,function(P,i){var Q=[];$.each(i.members,function(R,S){if(S.type=="to"){Q[S.way_ref]=true}});$.each(N,function(R,S){if((Q[S.way_ref]!=undefined&&i.access=="only")||(Q[S.way_ref]==undefined&&i.access=="no")){N[R].access=true}})});for(var M=0;M<N.length;M++){if(!N[M].access){d(K.via,K.via,'The restrictions at this node make a street inaccessible. Consider using "oneway" or "access=no" instead of restrictions.',false);return}}}function d(O,P,Q,N){var K="";var M="";switch(P.type){case"node":M="Node";K="http://www.openstreetmap.org/node/"+P.id;break;case"relation":M="Relation";K="http://www.openstreetmap.org/relation/"+P.id;break}Q="<b>"+(N?"Warning":"Error")+"</b>: "+Q;Q+="<br>"+M+' <a href="'+K+'" target="_blank">'+P.id+"</a>";console.log(Q);var R=N?"orange":"red";var i=L.circleMarker(O,{fillOpacity:1,opacity:1,fillColor:R,color:"white"}).setRadius(7).bindPopup(Q,{autoPan:false,offset:[0,-5]});q.addLayer(i)}function u(i,K){var N=[];for(var M in i){if(i.hasOwnProperty(M)){if(K){N.push(M)}else{N.push(i[M])}}}return N}function y(i){return i.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;")}});